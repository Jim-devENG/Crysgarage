name: Deploy to VPS

on:
  push:
    branches: [master, main]
  workflow_dispatch: # Allow manual deployment

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            echo "🚀 Starting deployment..."

            # Navigate to deployment directory
            cd /var/www/crysgarage-deploy

            # Pull latest changes
            echo "📥 Pulling latest changes..."
            git pull origin master

            # Stop existing containers
            echo "🛑 Stopping containers..."
            docker-compose down

            # Build and start containers
            echo "🔨 Building and starting containers..."
            docker-compose build --no-cache
            docker-compose up -d

            # Wait for services to start
            echo "⏳ Waiting for services to start..."
            sleep 15

            # Check container status
            echo "📊 Container status:"
            docker-compose ps

            # Test the application
            echo "🧪 Testing application..."
            if curl -s -f https://crysgarage.studio/health > /dev/null; then
              echo "✅ Deployment successful! Application is running."
            else
              echo "❌ Deployment failed! Application is not responding."
              exit 1
            fi

            echo "🌐 Application URL: https://crysgarage.studio"
