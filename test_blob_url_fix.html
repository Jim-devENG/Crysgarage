<!DOCTYPE html>
<html>
  <head>
    <title>Blob URL Reloading Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background-color: #1a1a1a;
        color: #ffffff;
      }
      .test-section {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #333;
        border-radius: 5px;
        background-color: #2a2a2a;
      }
      .success {
        background-color: #1e3a1e;
        border-color: #4a7c4a;
      }
      .error {
        background-color: #3a1e1e;
        border-color: #7c4a4a;
      }
      .info {
        background-color: #1e3a3a;
        border-color: #4a7c7c;
      }
      button {
        padding: 10px 15px;
        margin: 5px;
        border: none;
        border-radius: 3px;
        cursor: pointer;
        background-color: #4a7c4a;
        color: white;
      }
      button:hover {
        background-color: #5a8c5a;
      }
      #output {
        margin-top: 20px;
        padding: 10px;
        background-color: #2a2a2a;
        border-radius: 3px;
        max-height: 400px;
        overflow-y: auto;
      }
      .url-display {
        font-family: monospace;
        font-size: 12px;
        word-break: break-all;
        margin: 5px 0;
        padding: 5px;
        background-color: #1a1a1a;
        border-radius: 3px;
      }
    </style>
  </head>
  <body>
    <h1>üîß Blob URL Reloading Test</h1>

    <div class="test-section info">
      <h3>üìã Test Description</h3>
      <p>
        This test demonstrates the blob URL reloading issue and verifies the
        fix. The problem was that <code>URL.createObjectURL()</code> was being
        called on every render, creating new blob URLs constantly and causing
        rapid reloading.
      </p>
    </div>

    <div class="test-section">
      <h3>üß™ Test Controls</h3>
      <button onclick="testOriginalBehavior()">
        Test Original Behavior (Problematic)
      </button>
      <button onclick="testFixedBehavior()">
        Test Fixed Behavior (Memoized)
      </button>
      <button onclick="clearLog()">Clear Log</button>
      <button onclick="createTestFile()">Create Test File</button>
    </div>

    <div id="output"></div>

    <script>
      let testFile = null;
      let blobUrl = null;
      let renderCount = 0;

      function log(message, type = "info") {
        const output = document.getElementById("output");
        const timestamp = new Date().toLocaleTimeString();
        const color =
          type === "error"
            ? "#ff6b6b"
            : type === "success"
            ? "#51cf66"
            : "#74c0fc";
        output.innerHTML += `<p style="color: ${color}; margin: 5px 0;"><strong>[${timestamp}]</strong> ${message}</p>`;
        output.scrollTop = output.scrollHeight;
      }

      function createTestFile() {
        // Create a simple test file
        const testData = new Uint8Array(1000);
        testFile = new File([testData], "test_audio.wav", {type: "audio/wav"});
        log("‚úÖ Test file created: " + testFile.name, "success");
      }

      // Original problematic behavior (recreates blob URL on every call)
      function createBlobUrlOriginal(file) {
        renderCount++;
        const url = URL.createObjectURL(file);
        log(`üîÑ Render #${renderCount}: Created new blob URL: ${url}`, "error");
        return url;
      }

      // Fixed behavior (memoized)
      let memoizedUrl = null;
      let memoizedFile = null;
      function createBlobUrlFixed(file) {
        renderCount++;

        // Check if we already have a URL for this file
        if (memoizedUrl && memoizedFile === file) {
          log(
            `‚úÖ Render #${renderCount}: Reusing existing blob URL: ${memoizedUrl}`,
            "success"
          );
          return memoizedUrl;
        }

        // Create new URL only if file changed
        if (memoizedUrl) {
          URL.revokeObjectURL(memoizedUrl);
          log(`üóëÔ∏è Revoked previous blob URL: ${memoizedUrl}`, "info");
        }

        memoizedUrl = URL.createObjectURL(file);
        memoizedFile = file;
        log(
          `üÜï Render #${renderCount}: Created new blob URL: ${memoizedUrl}`,
          "success"
        );
        return memoizedUrl;
      }

      function testOriginalBehavior() {
        if (!testFile) {
          log("‚ùå Please create a test file first", "error");
          return;
        }

        log("üß™ Testing ORIGINAL behavior (problematic)...", "info");
        renderCount = 0;

        // Simulate multiple renders
        for (let i = 0; i < 5; i++) {
          const url = createBlobUrlOriginal(testFile);
          log(`üìä URL ${i + 1}: ${url}`, "info");
        }

        log(
          "‚ùå Original behavior creates new blob URL on every render!",
          "error"
        );
      }

      function testFixedBehavior() {
        if (!testFile) {
          log("‚ùå Please create a test file first", "error");
          return;
        }

        log("üß™ Testing FIXED behavior (memoized)...", "info");
        renderCount = 0;

        // Simulate multiple renders
        for (let i = 0; i < 5; i++) {
          const url = createBlobUrlFixed(testFile);
          log(`üìä URL ${i + 1}: ${url}`, "info");
        }

        log("‚úÖ Fixed behavior reuses the same blob URL!", "success");
      }

      function clearLog() {
        document.getElementById("output").innerHTML = "";
        log("üóëÔ∏è Log cleared", "info");
      }

      // Auto-create test file on page load
      window.onload = function () {
        log("üöÄ Blob URL Test Page Loaded", "success");
        createTestFile();
      };
    </script>
  </body>
</html>
